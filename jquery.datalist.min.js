(function(k,a,j){var d=k.document,f=!!("data" in d.createElement("datalist"))&&!!k.HTMLDataListElement&&!!("list" in d.createElement("input")),i=Array.prototype.some||function(m){var p;for(var n=0,o=this.length;n<o;n++){if((p=m(this[n],n,this))){return p}}return false},e=Array.prototype.filter||function(m){var q=[];for(var n=0,o=this.length,p;n<o;n++){if(m(p=this[n],n,this)){q.push(p)}}return q};function b(m){return parseInt(m,10)||0}function l(){return Math.max.apply(j,a("*").map(function(){return b(a(this).css("z-index"))}).get())}function c(m,p,o){var n=[];o.each(function(q){var t=a(this),u=t.attr("value")||t.text(),r=t.attr("label")||t.text(),s;n.push(s=a('<li style="padding: 2px; white-space: nowrap">').append('<span class="value">'+u+"</span>").append(a("<span>",{css:{opacity:0.8,"font-style":"italic","float":"right",display:r===u?"none":"inline"}}).text(r)).attr("title",r||u||"").appendTo(p)[0]);s.dataText=(r+" "+u).toLowerCase()});return n}function h(m,o,n){var r=m.val().toLowerCase(),q=n.matches||(n.matches=o),p=r.length>0&&r.indexOf(n.last)===0?q:o;if(n.last===r){return}n.last=r;n.matches=e.call(p,function(s){if(r.length===0||s.dataText.indexOf(r)>-1){s.style.display="block";return true}s.style.display="none"})}function g(n,p,m){var o=p.position(),q=l();m=m||"tl";n.css({top:o.top+(m.indexOf("b")>-1?p.outerHeight():-1)+b(p.css("margin-top")),left:o.left+(m.indexOf("r")>-1?p.outerWidth():0)+b(p.css("margin-left")),"z-index":Math.max(q,0)+100})}a.fn.datalist=function(m){m=a.extend({},{native_support:f,url:"",width:0},m);return m.native_support?this:this.each(function(){var n=a(this),q,t,u,o=a(d.getElementById(n.attr("list"))),r=o.find("option"),w=n.outerWidth()-2,p=n.height(),v=a("<ul>",{css:{width:m.width||w,position:n.css("position")==="fixed"?"fixed":"absolute",margin:0,padding:0,"list-style":"none",border:"1px solid #ccc","-moz-box-shadow":"0px 2px 3px #ccc","-webkit-box-shadow":"0px 2px 3px #ccc","box-shadow":"0px 2px 3px #ccc",cursor:"default","background-color":"Menu",color:"MenuText","max-height":130,overflow:"auto","font-size":n.css("font-size"),"font-family":n.css("font-family"),"line-height":n.css("line-height"),"font-weight":"normal"}});n.removeAttr("list").attr("autocomplete","off");if(!o.length&&!m.url){return}if(m.url||o.attr("data")){a.get(m.url||o.attr("data")).success(function(x){q=c(n,v,a(x).find("option"))})}else{q=c(n,v,r)}v.hide().insertAfter(n);var s={last:""};n.bind("start-hide",function(){n.trigger("cancel-hide");t=setTimeout(function(){n.trigger("hide-now")},300)}).bind("cancel-hide",function(){clearTimeout(t)}).bind("hide-now",function(){v.hide()}).bind("focus show-now",function(x){n.trigger("cancel-hide");g(v,n,"bl");if(x.type==="focus"){n.trigger("search")}v.show()}).blur(function(){n.trigger("start-hide")}).bind("keyup search",function(x){if(x.keyCode&&a.inArray(x.keyCode,[27,10,13,38,40])>-1){return}if(!v.is(":visible")){n.trigger("show-now")}clearTimeout(s.tmr);s.tmr=setTimeout(function(){h(n,q,s)},200)}).keydown(function(x){if(x.keyCode<=40){var A=v.find("li.selected:visible");if(x.keyCode==38){x.preventDefault();if(!v.is(":visible")){n.trigger("show-now")}if(A.length){A=A.trigger("mouseleave").prev(":visible")}}else{if(x.keyCode===40){x.preventDefault();if(!v.is(":visible")){n.trigger("show-now")}if(A.length){A=A.trigger("mouseleave").next(":visible")}else{A=v.find("li:visible:first").trigger("mouseenter")}}else{if(x.keyCode===27&&v.is(":visible")){x.preventDefault();n.trigger("hide-now")}else{if(x.keyCode===13&&v.is(":visible")){x.preventDefault();A.trigger("click")}}}}if(A.length){var B=A[0].offsetTop,z=v.scrollTop(),C=v.height(),y=A.height();if(z+C<B+y*2.5){v.stop().animate({scrollTop:B-C+y*2.5},50)}else{if(z>B){v.stop().animate({scrollTop:B-y},50)}}A.trigger("mouseenter")}}});v.delegate("li","click",function(){var x=a(this).find("span.value").text();n.val(x).trigger("hide-now")}).delegate("li","mouseenter",function(){v.find(".selected").removeClass("selected");a(this).css({"background-color":"Highlight",color:"HighlightText"}).addClass("selected")}).delegate("li","mouseleave",function(){a(this).css({"background-color":"Menu",color:"MenuText"}).removeClass("selected")}).bind("scroll",function(){clearTimeout(u);u=setTimeout(function(){n.trigger("focus")},100)})})};a(function(){a("[list]").datalist()})})(window,jQuery);