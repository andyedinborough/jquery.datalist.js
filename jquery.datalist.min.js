// HTML5 datalist plugin v.0.1
// Copyright (c) 2010-The End of Time, Mike Taylor, http://miketaylr.com
// MIT Licensed: http://www.opensource.org/licenses/mit-license.php
(function(j,a){var d=j.document,f=!!("data" in d.createElement("datalist"))&&!!j.HTMLDataListElement&&!!("list" in d.createElement("input")),i=Array.prototype.some||function(k){var n;for(var l=0,m=this.length;l<m;l++){if((n=k(this[l],l,this))){return n}}return false},e=Array.prototype.filter||function(k){var o=[];for(var l=0,m=this.length,n;l<m;l++){if(k(n=this[l],l,this)){o.push(n)}}return o};function b(k){return parseInt(k,10)||0}function c(k,n,m){var l=[];m.each(function(o){var r=a(this),s=r.attr("value")||r.text(),p=r.attr("label")||r.text(),q;l.push(q=a('<li style="padding: 2px; white-space: nowrap">').append('<span class="value">'+s+"</span>").append(a("<span>",{css:{opacity:0.8,"font-style":"italic","float":"right",display:p===s?"none":"inline"}}).text(p)).attr("title",p||s||"").appendTo(n)[0]);q.dataText=(p+" "+s).toLowerCase()});return l}function h(k,m,l){var p=k.val().toLowerCase(),o=l.matches||(l.matches=m),n=p.indexOf(l.last)===0?o:m;if(l.last===p){return}l.last=p;l.matches=e.call(n,function(q){if(q.dataText.indexOf(p)>-1){q.style.display="block";return true}q.style.display="none"})}function g(l,n,k){var m=n.position();k=k||"tl";l.css({top:m.top+(k.indexOf("b")>-1?n.outerHeight():-1)+b(n.css("margin-top")),left:m.left+(k.indexOf("r")>-1?n.outerWidth():0)+b(n.css("margin-left"))})}a.fn.datalist=function(){return f?this:this.each(function(){var k=a(this),n,q,l=a(d.getElementById(k.attr("list"))),o=l.find("option"),s=k.outerWidth()-2,m=k.height(),r=a("<ul>",{"class":"datalist",css:{width:s,position:k.css("position")==="fixed"?"fixed":"absolute",margin:0,padding:0,"list-style":"none",border:"1px solid #ccc","-moz-box-shadow":"0px 2px 3px #ccc","-webkit-box-shadow":"0px 2px 3px #ccc","box-shadow":"0px 2px 3px #ccc","z-index":99,cursor:"default","background-color":"Menu",color:"MenuText","max-height":130,overflow:"auto","font-size":k.css("font-size"),"font-family":k.css("font-family"),"line-height":k.css("line-height")}});k.removeAttr("list").attr("autocomplete","off");if(!l.length){return}if(l.attr("data")){a.get(l.attr("data")).success(function(t){n=c(k,r,a(t).find("option"))})}else{n=c(k,r,o)}r.hide().insertAfter(k);var p={last:""};k.bind("start-hide",function(){k.trigger("cancel-hide");q=setTimeout(function(){k.trigger("hide-now")},300)}).bind("cancel-hide",function(){clearTimeout(q)}).bind("hide-now",function(){r.hide()}).bind("focus show-now",function(t){k.trigger("cancel-hide");g(r,k,"bl");if(t.type==="focus"){k.keyup()}r.show()}).blur(function(){k.trigger("start-hide")}).keyup(function(t){if(t.keyCode>40){if(!r.is(":visible")){k.trigger("show-now")}clearTimeout(p.tmr);p.tmr=setTimeout(function(){h(k,n,p)},200)}}).keydown(function(t){if(t.keyCode<=40){var w=r.find("li.selected:visible");if(t.keyCode==38){t.preventDefault();if(!r.is(":visible")){k.trigger("show-now")}if(w.length){w=w.trigger("mouseleave").prev(":visible")}}else{if(t.keyCode===40){t.preventDefault();if(!r.is(":visible")){k.trigger("show-now")}if(w.length){w=w.trigger("mouseleave").next(":visible")}else{w=r.find("li:visible:first").trigger("mouseenter")}}else{if(t.keyCode===27&&r.is(":visible")){t.preventDefault();k.trigger("hide-now")}else{if(t.keyCode===13&&r.is(":visible")){t.preventDefault();w.trigger("click")}}}}if(w.length){var x=w[0].offsetTop,v=r.scrollTop(),y=r.height(),u=w.height();if(v+y<x+u*2.5){r.stop().animate({scrollTop:x-y+u*2.5},50)}else{if(v>x){r.stop().animate({scrollTop:x-u},50)}}w.trigger("mouseenter")}}});r.delegate("li","click",function(){var t=a(this).find("span.value").text();k.val(t).trigger("hide-now")}).delegate("li","mouseenter",function(){r.find(".selected").removeClass("selected");a(this).css({"background-color":"Highlight",color:"HighlightText"}).addClass("selected")}).delegate("li","mouseleave",function(){a(this).css({"background-color":"Menu",color:"MenuText"}).removeClass("selected")}).bind("scroll",function(){k.trigger("show-now")})})};a(function(){a("[list]").datalist()})})(window,jQuery);